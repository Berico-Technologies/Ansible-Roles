---
- name: Install EPEL Repository
  yum: name=http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm state=present

- name: Install REMI Repository
  yum: name=http://rpms.famillecollet.com/enterprise/remi-release-6.rpm state=present

- name: Install Erlang
  yum: name=erlang state=present

- name: Install RabbitMQ RPM key
  rpm_key: key=http://www.rabbitmq.com/rabbitmq-signing-key-public.asc

- name: Retrieve RabbitMQ RPM from RabbitMQ Website
  get_url: url="{{rabbitmq_url}}" dest="/usr/share/{{rabbitmq_rpm}}" mode=0440

- name: Install RabbitMQ RPM
  yum: name="/usr/share/{{rabbitmq_rpm}}" state=present

- name: Unblock the RabbitMQ AQMP Port
  lineinfile: dest=/etc/sysconfig/iptables
              regexp="^-A INPUT -p {{item.protocol}} -m {{item.protocol}} --dport {{item.port}} -j ACCEPT$"
              line="-A INPUT -p {{item.protocol}} -m {{item.protocol}} --dport {{item.port}} -j ACCEPT"
              insertafter="^:OUTPUT ACCEPT \[\d*:\d*\]$"
  with_items:
    - { protocol: tcp, port: 5672 }
  notify:
    - restart iptables
